# Неисправности shifty
Причина неисправности shifty связана не с синтаксисом devicetree, а с семантикой `zmk,behavior-tap-dance`:

1. Поведение tap-dance формирует выходное действие только после выбора варианта (по числу нажатий) и обычно ожидает истечения `tapping-term-ms` после последнего нажатия, прежде чем «выпустить» выбранный binding. ([ZMK Firmware][1])
2. В текущей конфигурации первый binding задан как `&kp LSHFT`. Нажатие Shift само по себе не печатает символ и визуально «ничего не делает», поэтому создаётся впечатление отсутствия срабатывания.
3. Если цель состоит в получении «одиночное нажатие — Shift для следующей клавиши», то `&kp LSHFT` не является «липким» Shift. Для такого сценария предназначен sticky key `&sk`, который удерживает модификатор до следующего нажатия. ([ZMK Firmware][2])
4. При использовании tap-dance для «Shift на одиночный tap» возможна ситуация, когда следующая клавиша нажимается раньше, чем tap-dance успевает выбрать и применить первый binding (из-за ожидания `tapping-term-ms`). Это воспринимается как «не срабатывает».

Практическое исправление для сценария «одиночный tap — Shift для следующей клавиши, двойной tap — caps_word» состоит в замене первого binding на sticky shift:

```dts
tap_dances {
    shifty: shift_caps_word {
        compatible = "zmk,behavior-tap-dance";
        display-name = "Shift+";
        #binding-cells = <0>;
        tapping-term-ms = <TAP_DANCE_TERM_MS>;
        bindings = <&sk LSHFT>, <&caps_word>;
    };
};
```

Пояснения к исправлению:

* `&sk LSHFT` реализует «липкий Shift» (модификатор действует до следующей клавиши), что соответствует ожидаемому эффекту от одиночного нажатия. ([ZMK Firmware][2])
* `&caps_word` является отдельным поведением и корректно вызывается без параметров. ([ZMK Firmware][3])

Дополнительная настройка (при необходимости):

* Если двойной tap распознаётся нестабильно, допускается увеличить `TAP_DANCE_TERM_MS` (например, до 180–220 мс). Следует учитывать, что увеличение `tapping-term-ms` одновременно увеличивает задержку, после которой выбирается одиночный вариант tap-dance. ([ZMK Firmware][1])

Если требуется именно «удержание — обычный Shift без задержки» (модификатор должен начинать действовать сразу при удержании, без ожидания решения tap-dance), то tap-dance для Shift является конструктивно неподходящим механизмом; в таком случае рекомендуется переносить Shift на отдельный `&kp LSHFT` или проектировать поведение через hold-tap, а `caps_word` выносить на отдельную клавишу/комбо. ([ZMK Firmware][4])

[1]: https://zmk.dev/docs/keymaps/behaviors/tap-dance?utm_source=chatgpt.com "Tap-Dance Behavior"
[2]: https://zmk.dev/docs/keymaps/behaviors/sticky-key?utm_source=chatgpt.com "Sticky Key Behavior"
[3]: https://zmk.dev/docs/keymaps/behaviors/caps-word "Caps Word Behavior | ZMK Firmware"
[4]: https://zmk.dev/docs/keymaps/behaviors/hold-tap?utm_source=chatgpt.com "Hold-Tap Behavior"


# Отсутствие переключения раскладки при нажатии комбинаций `D+F` и `J+K`,

Причина отсутствия переключения раскладки при нажатии комбинаций `D+F` и `J+K`, как правило, связана с параметрами самих `combos`, а не с определением `macros`:

1. Ограничение по слоям. В текущей конфигурации `combo_lang_en` и `combo_lang_ru` ограничены свойством `layers = <BASE_L>;`. При активном поверх базового любого другого слоя (например, при удержании `&mo NUM_L`, `&lt NAV_L RET`, при срабатывании tri-layer `MED_L`) ограничение может блокировать срабатывание combo, поскольку combo разрешается только на указанных слоях. Возможность ограничения combos по слоям задаётся свойством `layers`, при его отсутствии combo имеет глобальную область действия. ([ZMK Firmware][1])
2. Фильтр простоя `require-prior-idle-ms`. Значение `150` мс блокирует combo, если незадолго до начала combo выполнялся обычный ввод. При попытке переключить раскладку «с ходу» сразу после набора символа без паузы 150 мс combo будет подавлено и на хост уйдут обычные `d f` или `j k`. ([ZMK Firmware][1])
3. Слишком малое окно одновременности. `timeout-ms = 120` мс часто оказывается жёстким для «человеческого» нажатия двух буквенных клавиш; в результате ZMK фиксирует два независимых нажатия, а не combo. Требование “все клавиши в пределах timeout” является базовым правилом combos. ([ZMK Firmware][1])

Ниже приведены исправления, устраняющие указанные причины: снято ограничение по слоям (combo становится глобальной) и увеличено окно `timeout-ms`; порог `require-prior-idle-ms` уменьшен до 50 мс, чтобы combo продолжало иметь базовую защиту от ложных срабатываний, но не требовало заметной паузы.

Внести изменения следует в раздел `Definitions` и в определения `combo_lang_en`/`combo_lang_ru`:

```dts
/* Унифицированные константы настройки combos */
#define COMBO_TIMEOUT_MS 120
#define COMBO_TIMEOUT_COMMAND_MS COMBO_TIMEOUT_MS
#define COMBO_TIMEOUT_LANG_TOG_MS 2000  /* Разрешает последовательное нажатие: удержание GUI, затем Space в течение 2 с */

/* Исправление: отдельные параметры для переключения раскладки (D+F, J+K) */
#define COMBO_TIMEOUT_LANG_SEL_MS 220   /* Увеличенное окно одновременности для буквенных combo */
#define COMBO_IDLE_LANG_SEL_MS 50       /* Снижение порога простоя для более «живого» переключения */

#define COMBO_IDLE_SYMBOL_MS 150
#define COMBO_IDLE_COMMAND_MS 150
#define COMBO_IDLE_DANGER_MS 250

...

/* ---------------------------------------------------------------------
 * Language switching combos (global)
 * ---------------------------------------------------------------------
 * Назначение: выбор раскладки через hotkeys ОС:
 * - D + F -> EN (Left Alt + Shift)
 * - J + K -> RU (Right Alt + Shift)
 *
 * Исправление:
 * - свойство layers удалено, чтобы combo работала на любом активном слое;
 * - timeout-ms увеличен до 220 мс;
 * - require-prior-idle-ms уменьшен до 50 мс.
 */
combo_lang_en {
    timeout-ms = <COMBO_TIMEOUT_LANG_SEL_MS>;
    require-prior-idle-ms = <COMBO_IDLE_LANG_SEL_MS>;
    key-positions = <15 16>;
    bindings = <&lang_en>;
};

combo_lang_ru {
    timeout-ms = <COMBO_TIMEOUT_LANG_SEL_MS>;
    require-prior-idle-ms = <COMBO_IDLE_LANG_SEL_MS>;
    key-positions = <19 20>;
    bindings = <&lang_ru>;
};
```

Примечание по диагностике (для исключения проблемы на стороне ОС): если при нажатии на обычной клавиатуре хоста сочетания `Left Alt + Shift` и `Right Alt + Shift` не переключают раскладку в требуемом режиме, то macro будет отрабатываться, но ОС не выполнит переключение. В этом случае следует скорректировать горячие клавиши в настройках ОС под реально используемые сочетания.

[1]: https://zmk.dev/docs/keymaps/combos "Combos | ZMK Firmware"

