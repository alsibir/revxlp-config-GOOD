# Использование комбинаций клавиш (combos) в ZMK: настройка и диагностика

## 1 Назначение и область применения

Комбинации клавиш (combos) в прошивке ZMK предназначены для формирования альтернативного действия при одновременном (хордном) нажатии двух и более клавиш. Типовой сценарий применения — вынесение редко используемых символов и команд (например, Escape, скобки, загрузчик) в «двухклавишные аккорды» без выделения отдельных физических клавиш. ([zmk.dev][1])

Настройка combos выполняется в конфигурации раскладки ZMK на базе синтаксиса devicetree.

## 2 Архитектурный принцип работы combos

2.1 Порядок обработки
Комбинации обрабатываются до применения обычной раскладки (узла `keymap`) и потому задаются отдельным узлом `combos` в файле `.keymap`. Это обеспечивает приоритетное распознавание combos над «обычными» нажатиями. ([zmk.dev][1])

2.2 Условие срабатывания
Комбинация срабатывает только при выполнении двух условий:

* все позиции, перечисленные в `key-positions`, нажаты в пределах времени `timeout-ms`;
* (при наличии) активный слой входит в перечень `layers`. ([zmk.dev][1])

Нарушение любого условия приводит к штатной отправке обычных нажатий, что воспринимается как «пробивание букв».

## 3 Размещение и базовая структура конфигурации

3.1 Требуемая структура
Минимальная структура определения combos в `.keymap` выглядит следующим образом: ([zmk.dev][1])

```dts
/ {
    combos {
        compatible = "zmk,combos";

        combo_esc {
            timeout-ms = <50>;
            key-positions = <0 1>;
            bindings = <&kp ESC>;
        };
    };
};
```

3.2 Обязательные свойства
Для каждого дочернего узла combo обязательны:

* `key-positions` — список индексов позиций клавиш;
* `bindings` — действие (behavior), выполняемое при срабатывании;
* `timeout-ms` — окно времени (в миллисекундах), в пределах которого должны быть нажаты все позиции. ([zmk.dev][2])

## 4 Параметры combos и практическая интерпретация

4.1 `timeout-ms`
Параметр определяет допустимую «неодновременность» нажатий. Значение по умолчанию составляет 50 мс. Чем меньше значение, тем выше требования к синхронности нажатий и тем чаще будут проходить «обычные буквы» вместо combo. ([zmk.dev][2])

Рекомендация для подбора:

* 80–100 мс для большинства двухклавишных combos при наборе одной рукой;
* 100–150 мс для combos, выполняемых «прокатыванием» пальцев, либо при жёстких/длинноходных переключателях.

4.2 `layers`
Свойство ограничивает набор слоёв, на которых combo разрешено. При отсутствии `layers` combo имеет глобальную область действия (все слои). ([zmk.dev][1])

Типовая ошибка: ожидание срабатывания combo на базовом слое при фактическом ограничении только на служебный (например, цифровой) слой. В этом случае срабатывание невозможно по определению, и будут отправлены обычные символы.

4.3 `slow-release`
По умолчанию combo «отпускается» при отпускании любой клавиши из набора. При включении `slow-release` отпускание происходит только когда отпущены все клавиши из `key-positions`. ([zmk.dev][1])

Практическое применение:

* полезно для combos, привязанных к модификаторам или «удерживаемым» действиям;
* нежелательно для combos, где требуется быстрый «клик», если удержание мешает следующим нажатиям.

4.4 `require-prior-idle-ms`
Параметр запрещает срабатывание combo, если перед началом нажатия combo в течение заданного интервала была нажата любая «не модификаторная» клавиша. Назначение — снижение ложных срабатываний combos при скоростном наборе. ([zmk.dev][1])

Практическое применение:

* если combos «случайно» срабатывают при быстром наборе, целесообразно добавить `require-prior-idle-ms` (например, 100–200 мс) и затем скорректировать по ощущениям;
* если combos «перестают срабатывать» при скоростном вводе, значение `require-prior-idle-ms` следует уменьшить либо отключить.

## 5 Определение позиций клавиш (`key-positions`)

Позиции — это индексы клавиш в порядке, соответствующем описанию раскладки в `.keymap`, начиная с 0. Иначе говоря, первая клавиша слоя имеет позицию 0, следующая — 1 и т. д. ([zmk.dev][1])

Рекомендуемый порядок действий:

1. открыть базовый слой в `.keymap`;
2. пронумеровать позиции слева направо по строкам (в том порядке, в котором они перечислены в раскладке);
3. подставить индексы нужных клавиш в `key-positions`.

## 6 Типовые причины «пробивания букв» и способы устранения

6.1 Слишком малое `timeout-ms`
Признак: combo «иногда» срабатывает, но чаще проходят обычные буквы, особенно при наборе одной рукой.
Действие: увеличить `timeout-ms` и повторить проверку. ([zmk.dev][2])

6.2 Ограничение `layers` не соответствует ожидаемому слою
Признак: combo «никогда» не срабатывает на базовом слое, но потенциально может срабатывать на служебном.
Действие: удалить `layers` (для глобального действия) либо добавить нужные слои в список `layers`. ([zmk.dev][1])

6.3 Неподходящая эргономика активации слоя для combos
Если combo разрешено только на слое, требуется обеспечить, что слой активен на момент нажатия обеих клавиш combo. Для «временного слоя» обычно применяют удержание (например, поведение слоя типа «моментальное включение на удержании»), чтобы слой гарантированно сохранялся в течение нажатия combo. (Общее описание поведения слоёв приведено в документации по поведениями слоёв ZMK.) ([zmk.dev][1])

6.4 Влияние сканирования и подавления дребезга
Если фактическая регистрация нажатий имеет заметную задержку, окно `timeout-ms` может «съедаться» обработкой событий клавиатурного сканирования и дебаунса. В ZMK предусмотрена настройка параметров дебаунса через `CONFIG_ZMK_KSCAN_DEBOUNCE_PRESS_MS` и `CONFIG_ZMK_KSCAN_DEBOUNCE_RELEASE_MS`, а также через свойства devicetree для конкретного драйвера сканирования. ([zmk.dev][3])

Рекомендуемый подход:

* в первую очередь корректировать `timeout-ms`;
* к настройкам дебаунса переходить только при наличии симптомов задержек/дребезга (двойные срабатывания, пропуски, нестабильные нажатия).

6.5 Ограничение числа одновременно активных combos
При сложных схемах (перекрывающиеся combos, многоклавишные combos, частые одновременные нажатия) может потребоваться увеличение предельного значения активных combos через `CONFIG_ZMK_COMBO_MAX_PRESSED_COMBOS` (по умолчанию 4). ([zmk.dev][2])

## 7 Рекомендованная методика настройки combos

7.1 Базовая настройка

1. задать combos без `layers` (глобально) для первичной проверки корректности `key-positions`;
2. установить `timeout-ms` 80–100 мс;
3. проверить срабатывание на целевом устройстве ввода.

7.2 Уточнение под сценарий

1. при ложных срабатываниях — добавить `require-prior-idle-ms` и подобрать значение; ([zmk.dev][1])
2. при необходимости слоевого поведения — добавить `layers` и проверить, что слой активируется предсказуемо; ([zmk.dev][1])
3. при необходимости удержания действия combo — включить `slow-release`. ([zmk.dev][1])

7.3 Контрольная диагностика

* проверить combos на базовом слое и на всех слоях, перечисленных в `layers`;
* проверить работу при «прокатывании» пальцев и при строго одновременном нажатии;
* при систематической нестабильности — оценить влияние параметров дебаунса и сканирования. ([zmk.dev][3])

## 8 Пример расширенной конфигурации

```dts
/ {
    combos {
        compatible = "zmk,combos";

        combo_esc {
            timeout-ms = <90>;
            key-positions = <0 1>;
            bindings = <&kp ESC>;
        };

        combo_boot {
            timeout-ms = <130>;
            key-positions = <5 6>;
            layers = <3>;
            bindings = <&bootloader>;
            slow-release;
            require-prior-idle-ms = <150>;
        };
    };
};
```

Семантика параметров в примере соответствует спецификации `zmk,combos`: `timeout-ms`, `layers`, `slow-release`, `require-prior-idle-ms` являются штатными свойствами combos в ZMK. ([zmk.dev][2])

## 9 Заключительные положения

Корректная работа combos в ZMK достигается согласованием трёх аспектов:

* правильной адресации клавиш через `key-positions` (индексация от 0 по порядку в раскладке); ([zmk.dev][1])
* реалистичного окна одновременности `timeout-ms` с учётом техники набора; ([zmk.dev][2])
* корректного управления областью действия combos по слоям (`layers`) и противодействия ложным срабатываниям (`require-prior-idle-ms`, `slow-release` по необходимости). ([zmk.dev][1])

[1]: https://zmk.dev/docs/keymaps/combos "Combos | ZMK Firmware"
[2]: https://zmk.dev/docs/config/combos "Combo Configuration | ZMK Firmware"
[3]: https://zmk.dev/docs/features/debouncing?utm_source=chatgpt.com "Debouncing"

## 10 Почему не работает
В предоставленном архиве определения комбинаций размещены в файле `config/revxlp.keymap` в узле `combos` с `compatible = "zmk,combos"`. Для всех комбинаций задано `timeout-ms = <50>`, а часть комбинаций дополнительно ограничена по слоям через свойство `layers`. Согласно документации ZMK, комбинация срабатывает только при нажатии всех клавиш из `key-positions` в пределах `timeout-ms`, при этом `layers` (если задано) ограничивает набор слоёв, на которых разрешено срабатывание; при отсутствии `layers` комбинация действует на всех слоях. ([ZMK Firmware][1])

1. Причины, по которым вместо комбинации «пробиваются» обычные символы
   1.1 Недостаточный интервал `timeout-ms`
   Значение `timeout-ms = 50` является значением по умолчанию и нередко оказывается слишком жёстким для комбинаций одной рукой (особенно при «прокатывании» пальцев). При превышении окна `timeout-ms` ZMK трактует нажатия как отдельные клавиши. ([ZMK Firmware][1])

1.2 Несоответствие активного слоя ограничениям `layers`
В архиве имеются комбинации, ограниченные слоями `NUM_L` и `MED_L`. Например, `l_curly_bracket` ограничена `layers = <NUM_L>`, а `bootloader_combo` ограничена `layers = <MED_L>`. Если комбинация нажимается на базовом слое, она по определению не должна сработать и будут отправлены обычные нажатия. ([ZMK Firmware][2])

1.3 Неправильное ожидание «последовательного» срабатывания
Комбинации в ZMK рассчитаны на «хордовый» ввод: все клавиши из `key-positions` должны быть нажаты в пределах окна `timeout-ms`. Если одна клавиша успевает отжаться до нажатия второй (даже «быстро»), комбинация часто не формируется.

2. Что именно в архиве влияет на наблюдаемое поведение
   Ниже приведена расшифровка текущих `key-positions` относительно слоя `Base` (позиции нумеруются по порядку клавиш в раскладке, начиная с 0). ([ZMK Firmware][1])

| Комбинация       | key-positions | Физические клавиши (слой Base) | Ограничение `layers` | Результат      |
| ---------------- | ------------: | ------------------------------ | -------------------- | -------------- |
| l_curly_bracket  |          2 14 | W + S                          | NUM_L                | `&kp LS(LBKT)` |
| r_curly_bracket  |          4 16 | R + F                          | NUM_L                | `&kp LS(RBKT)` |
| lbracket         |         14 26 | S + X                          | NUM_L                | `&kp LBKT`     |
| rbracket         |         16 28 | F + V                          | NUM_L                | `&kp RBKT`     |
| ques_mark_combo  |         21 33 | L + DOT                        | нет                  | `&kp LS(FSLH)` |
| bslash_combo     |         10 22 | P + SEMI                       | нет                  | `&kp BSLH`     |
| fslash_combo     |         22 34 | SEMI + FSLH                    | нет                  | `&kp FSLH`     |
| bootloader_combo |           5 6 | T + Y                          | MED_L                | `&bootloader`  |
| gui_combo        |         16 19 | F + J                          | MED_L                | `&kp LGUI`     |

Из таблицы следует:

* комбинации для скобок/фигурных скобок не сработают на базовом слое, так как ограничены `NUM_L`;
* комбинации `bootloader_combo` и `gui_combo` не сработают на базовом слое, так как ограничены `MED_L`;
* глобальные комбинации (без `layers`) зависят прежде всего от корректного подбора `timeout-ms`.

3. Рекомендуемые изменения для «штатной» работы комбинаций
   3.1 Увеличить `timeout-ms`
   Рекомендуется начать со значений:

* 80–100 мс для глобальных комбинаций без `layers`;
* 100–150 мс для комбинаций одной рукой и/или для комбинаций, которые используются осознанно и не должны мешать обычному набору.
  Свойство `timeout-ms` предназначено именно для настройки окна одновременности. ([ZMK Firmware][2])

3.2 Привести логику `layers` в соответствие ожидаемому сценарию
Варианты:

* если комбинация должна работать на базовом слое, свойство `layers` следует удалить (или явно включить слой 0);
* если комбинация должна работать только на слое, необходимо гарантировать, что слой активен на момент нажатия обеих клавиш комбинации. Для этого подходит удержание `&mo` (слой активен только пока клавиша удерживается). ([ZMK Firmware][3])
  Примечание: `&sl` является «одноразовым» (one shot) слоем и по смыслу отключается при следующем нажатии; для двухклавишных комбинаций на этом слое такой режим часто неудобен, так как слой может сняться «на первой клавише» комбинации. ([ZMK Firmware][4])
  Если требуется включать слой без удержания, целесообразнее рассмотреть `&tog` (переключатель слоя) либо иные схемы на базе `&to`/`&tog`. ([ZMK Firmware][3])

3.3 При необходимости скорректировать задержки сканирования и подавления дребезга
Если нажатия фиксируются с заметной задержкой, окно `timeout-ms` фактически «съедается» обработкой сканирования/дребезга. В ZMK по умолчанию решение о нажатии/отжатии принимается после 5 мс стабильного сигнала; параметры задаются через `CONFIG_ZMK_KSCAN_DEBOUNCE_PRESS_MS` и `CONFIG_ZMK_KSCAN_DEBOUNCE_RELEASE_MS` (либо через свойства узла `kscan`). ([ZMK Firmware][5])
Практический подход: сначала увеличить `timeout-ms`; к дебаунсу переходить только если проблема явно похожа на задержки/пропуски.

4. Готовая правка для текущего архива (без изменения логики слоёв)
   Подготовлен вариант архива, где изменены только значения `timeout-ms` в `config/revxlp.keymap`:

* для комбинаций с `layers` установлено `timeout-ms = <120>`;
* для комбинаций без `layers` установлено `timeout-ms = <80>`.
  Это повышает вероятность срабатывания без изменения привязок и ограничений по слоям.

[Скачать архив с правками](sandbox:/mnt/data/revxlp-config-GOOD-main-combosfix.zip)

Если после увеличения `timeout-ms` продолжают «пробиваться» символы именно у комбинаций с `layers = <NUM_L>` или `layers = <MED_L>`, причиной, как правило, является отсутствие активного слоя в момент выполнения комбинации; в этом случае требуется корректировка сценария активации слоя (удержание `&mo`, либо переход на `&tog`/`&to` в зависимости от требуемой эргономики). ([ZMK Firmware][3])

[1]: https://zmk.dev/docs/keymaps/combos "Combos | ZMK Firmware"
[2]: https://zmk.dev/docs/config/combos "Combo Configuration | ZMK Firmware"
[3]: https://zmk.dev/docs/keymaps/behaviors/layers "Layer Behaviors | ZMK Firmware"
[4]: https://zmk.dev/docs/keymaps/behaviors/sticky-layer "Sticky Layer Behavior | ZMK Firmware"
[5]: https://zmk.dev/docs/features/debouncing "Debouncing | ZMK Firmware"




