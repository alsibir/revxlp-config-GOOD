# revxlp ZMK user configuration (xiao_ble//zmk)

## 1 Назначение репозитория
Репозиторий предназначен для хранения и воспроизводимой сборки конфигурации прошивки ZMK для самодельной клавиатуры `revxlp` на контроллере Seeed Studio XIAO BLE (nRF52840). Конфигурация ориентирована на сборку строго под целевую плату `xiao_ble//zmk` и набор shield:
- `revxlp` — основная прошивка клавиатуры;
- `settings_reset` — прошивка сброса настроек ZMK.

Сборка выполняется через GitHub Actions (reusable workflow ZMK) и, при необходимости, локально с использованием `west`.

## 2 Поддерживаемые цели сборки
- Плата (board): `xiao_ble//zmk`
- Shield: `revxlp`, `settings_reset`

В репозитории предусмотрена проверка на отсутствие устаревших обозначений плат (например, `seeeduino _xiao_ble`, `seeeduino _xiao`) во всех файлах проекта.

## 3 Краткое описание аппаратной конфигурации
- Контроллер: Seeed Studio XIAO BLE (nRF52840).
- Матрица клавиатуры: 6 столбцов × 7 строк.
- Управление столбцами: сдвиговый регистр 74HC595 (SPI), сканирование матрицы реализовано на стороне shield `revxlp`.

## 4 Структура репозитория
Типовая структура (может расширяться):
- `build.yaml` — матрица сборки GitHub Actions (board/shield).
- `config/`
  - `revxlp.conf` — конфигурация Kconfig для целевого shield.
  - `revxlp.keymap` — раскладка ZMK для shield.
- `boards/`
  - `shields/revxlp/` — описание shield, overlay и привязки к плате.
- `.github/workflows/`
  - `build.yml` — pipeline сборки и верификации.

## 5 Сборка через GitHub Actions
1. Выполнить отправку изменений в ветку `main` или открыть pull request.
2. Перейти в GitHub: вкладка Actions → выбрать workflow сборки.
3. По завершении job скачать артефакты (файлы прошивок `.uf2`) из результата выполнения workflow.

Результаты сборки формируются на основе `build.yaml`. При изменении board/shield следует вносить изменения только в `build.yaml` и связанные файлы конфигурации.

## 6 Локальная сборка (west)
### 6.1 Предварительные требования
- Linux (рекомендуется Ubuntu/Debian-совместимые).
- `west` и зависимости ZMK/Zephyr.
- Установленный Zephyr SDK (версия определяется используемым стеком ZMK/Zephyr).

Примечание: наиболее воспроизводимый вариант локальной сборки — использование официального окружения ZMK (контейнер/докер или dev container), чтобы исключить расхождения версий инструментов.

### 6.2 Команды сборки
Пример сборки основной прошивки:
```bash
west build -s zmk/app -d build/revxlp -b xiao_ble//zmk -- \
  -DZMK_CONFIG="$(pwd)/config" \
  -DSHIELD=revxlp
````

Пример сборки прошивки сброса:

```bash
west build -s zmk/app -d build/settings_reset -b xiao_ble//zmk -- \
  -DZMK_CONFIG="$(pwd)/config" \
  -DSHIELD=settings_reset
```

Готовые файлы `.uf2` формируются в каталоге сборки (как правило, `build/<target>/zephyr/`).

## 7 Прошивка контроллера (UF2)

1. Перевести XIAO BLE в режим загрузчика UF2 (обычно двойное нажатие кнопки Reset).
2. В системе появится USB-накопитель (диск загрузчика).
3. Скопировать нужный файл `.uf2` на этот накопитель.
4. Дождаться автоматического перезапуска контроллера.

Рекомендуемый порядок при устранении проблем с настройками:

1. прошить `settings_reset`;
2. затем прошить основную прошивку `revxlp`.

## 8 Внесение изменений в раскладку и конфигурацию

* Раскладка: редактирование `config/revxlp.keymap`.
* Параметры Kconfig: редактирование `config/revxlp.conf`.
* Описание аппаратной части shield (матрица, линии, SPI и пр.): `boards/shields/revxlp/*`.

После изменений рекомендуется:

1. выполнить локальную проверку (сборка или статическая валидация);
2. отправить изменения в репозиторий и дождаться успешного прохождения GitHub Actions.

## 9 Контроль именования плат и типовые проверки

Для предотвращения использования устаревших имен плат в репозитории применяется проверка в CI. При необходимости локальной проверки:

```bash
grep -RIn --exclude-dir=.git --exclude-dir=build \
  -E 'seeeduino _xiao_ble|seeeduino _xiao([^_]|$)' .
```

Также рекомендуется контролировать отсутствие устаревших/неопределённых Kconfig-символов в `config/*.conf` перед отправкой изменений.


